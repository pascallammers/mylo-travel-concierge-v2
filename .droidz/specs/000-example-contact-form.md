---
spec-id: 000
feature: Contact Form with Email Delivery
complexity: simple
execution-strategy: sequential
created: 2025-11-15T12:00:00Z
dependencies: []
---

# Feature Specification: Contact Form with Email Delivery

> **Note:** This is an example specification demonstrating the format generated by `/droidz-build`.

<objective>
Implement a contact form component that collects user information (name, email, message) and sends it via email to the site administrator.
</objective>

<context>
**User Request:** "Add a contact form to the website"

**Project Type:** Existing Next.js 14 application
**Tech Stack:** Next.js 14, TypeScript, React, Tailwind CSS
**Framework:** Next.js App Router
**Email Service:** Resend (via API)
**Target Users:** Website visitors wanting to contact the business
**Why This Matters:** Provides a direct communication channel for potential customers and reduces spam compared to displaying a public email address.
</context>

<requirements>
**Functional Requirements:**
1. Form with fields: name, email, subject, message
2. Client-side validation (required fields, email format)
3. Server-side API endpoint to handle form submission
4. Email delivery to admin@example.com
5. Success/error feedback to user
6. Rate limiting to prevent spam (max 5 submissions per hour per IP)

**Non-Functional Requirements:**
1. Form submission response time < 2 seconds
2. Accessible (WCAG 2.1 Level AA compliance)
3. Mobile-responsive design
4. Graceful error handling for email delivery failures
</requirements>

<task-decomposition>
**Phase 1: Implementation (Sequential)**

Task 1.1: Contact Form Component
- **droidz:** droidz-codegen
- **priority:** high
- **files:** 
  - `components/ContactForm.tsx` - React component with form UI
  - `lib/validations/contact.ts` - Zod schema for form validation
- **dependencies:** None
- **acceptance criteria:**
  - Form includes name, email, subject, message fields
  - Client-side validation using Zod
  - Loading state during submission
  - Success/error messages displayed
  - Fully responsive (mobile, tablet, desktop)
  - Accessible form labels and ARIA attributes

Task 1.2: API Endpoint
- **droidz:** droidz-codegen
- **priority:** high
- **files:**
  - `app/api/contact/route.ts` - API route handler
  - `lib/email/contact-email.ts` - Email template and sending logic
- **dependencies:** Task 1.1 (needs validation schema)
- **acceptance criteria:**
  - POST endpoint at `/api/contact`
  - Validates request body with Zod schema
  - Sends email via Resend API
  - Returns 200 on success, 400 for validation errors, 500 for email failures
  - Rate limiting implemented (5 requests/hour per IP)
  - Environment variable for admin email address

Task 1.3: Integration Tests
- **droidz:** droidz-test
- **priority:** medium
- **files:**
  - `__tests__/components/ContactForm.test.tsx` - Component tests
  - `__tests__/api/contact.test.ts` - API endpoint tests
- **dependencies:** Tasks 1.1, 1.2
- **acceptance criteria:**
  - Component tests: form rendering, validation, submission
  - API tests: successful submission, validation errors, rate limiting
  - Mock email service in tests
  - Coverage ≥ 80%

</task-decomposition>

<security-requirements>
**Critical Security Measures:**

1. Input Sanitization
   - **Implementation:** Sanitize all input fields to prevent XSS attacks
   - **Validation:** Use Zod schema to validate and sanitize inputs
   - **Test:** Submit malicious scripts in form fields and verify they're sanitized

2. Rate Limiting
   - **Implementation:** Limit to 5 submissions per hour per IP address
   - **Validation:** Use upstash/ratelimit or similar library
   - **Test:** Submit 6 requests rapidly and verify 6th is blocked with 429 status

3. Environment Variables
   - **Implementation:** Store Resend API key and admin email in .env.local
   - **Validation:** Never commit .env.local to git, use .env.example
   - **Test:** Check that no secrets are hardcoded in source code

4. CSRF Protection
   - **Implementation:** Next.js API routes have built-in CSRF protection
   - **Validation:** Verify requests from same origin
   - **Test:** Attempt cross-origin request and verify it's blocked

**OWASP Top 10 Compliance:**

- [x] A03:2021 – Injection → Input sanitization with Zod
- [x] A04:2021 – Insecure Design → Rate limiting prevents abuse
- [x] A05:2021 – Security Misconfiguration → Environment variables for secrets
- [x] A07:2021 – Identification and Authentication Failures → N/A (no auth)

</security-requirements>

<edge-cases>
**Scenarios to Handle:**

1. Email Service Unavailable
   - **Scenario:** Resend API is down or returns error
   - **Expected Behavior:** Return 500 error, log failure, show user-friendly message
   - **Error Message:** "Unable to send message. Please try again later."
   - **HTTP Status:** 500

2. Invalid Email Format
   - **Scenario:** User submits malformed email address
   - **Expected Behavior:** Client-side validation catches it before submission
   - **Error Message:** "Please enter a valid email address"
   - **HTTP Status:** N/A (caught client-side)

3. Rate Limit Exceeded
   - **Scenario:** User submits form more than 5 times in an hour
   - **Expected Behavior:** API returns rate limit error
   - **Error Message:** "Too many requests. Please try again later."
   - **HTTP Status:** 429

4. Empty Required Fields
   - **Scenario:** User submits form with missing required fields
   - **Expected Behavior:** Client-side validation shows field-specific errors
   - **Error Message:** "[Field name] is required"
   - **HTTP Status:** N/A (caught client-side)

5. Very Long Message
   - **Scenario:** User submits message > 5000 characters
   - **Expected Behavior:** Validation limits message to 5000 chars
   - **Error Message:** "Message must be less than 5000 characters"
   - **HTTP Status:** 400 (if client validation bypassed)

</edge-cases>

<testing-strategy>
**Test Coverage Plan:**

**Unit Tests:**
- Form validation logic (Zod schema)
- Email template generation
- Rate limiter function

**Component Tests (React Testing Library):**
- Form renders all fields correctly
- Validation errors display properly
- Success message shows after submission
- Loading state during submission
- Accessibility checks (form labels, ARIA)

**Integration Tests:**
- Full flow: render form → fill fields → submit → verify API called
- API endpoint with valid data returns 200
- API endpoint with invalid data returns 400
- Rate limiting blocks after 5 requests
- Email service mock receives correct data

**E2E Tests (Optional - Playwright):**
- User fills out form → submits → sees success message
- User submits invalid data → sees error messages
- Form is accessible via keyboard navigation

**Target Coverage:** 80%+

</testing-strategy>

<verification-criteria>
**Before Marking Complete:**

✅ Form component renders on contact page
✅ All validation rules work (required fields, email format, character limits)
✅ API endpoint successfully sends emails (tested in dev)
✅ Rate limiting blocks after 5 submissions per hour
✅ Success and error messages display correctly
✅ Form is mobile-responsive (tested on 3 screen sizes)
✅ Accessibility audit passes (no critical issues)
✅ All tests passing with ≥80% coverage
✅ No API keys or secrets hardcoded in source
✅ Environment variables documented in .env.example
✅ Error handling works when email service fails

</verification-criteria>

<execution-plan>
**Recommended Execution Strategy:** Sequential (tasks have dependencies)

**Why Sequential:** Task 1.2 depends on validation schema from Task 1.1, and Task 1.3 needs both components to be complete.

**Task Execution Order:**

```typescript
// Task 1.1: Contact Form Component
Task({
  subagent_type: "droidz-codegen",
  description: "Build contact form component with validation",
  prompt: `# Task: Build Contact Form Component

## Objective
Create a fully accessible, responsive contact form component with client-side validation.

## Context
**Project:** Existing Next.js 14 app (App Router)
**Tech Stack:** Next.js 14, TypeScript, React, Tailwind CSS
**User Request:** Add a contact form to the website
**Related Tasks:** This task will be followed by API endpoint creation

## Requirements
1. Create ContactForm component in \`components/ContactForm.tsx\`
2. Create Zod validation schema in \`lib/validations/contact.ts\`
3. Form fields: name (required), email (required, valid format), subject (required), message (required, max 5000 chars)
4. Client-side validation with error messages
5. Loading state during submission
6. Success/error message display
7. Mobile-responsive design with Tailwind CSS
8. Accessible (WCAG 2.1 AA): proper labels, ARIA attributes, keyboard navigation

## Files to Create
- \`components/ContactForm.tsx\`:
  - React component using useState for form state
  - Zod validation on submit
  - Fetch API call to \`/api/contact\`
  - Loading/success/error states
  - Tailwind CSS for styling

- \`lib/validations/contact.ts\`:
  - Zod schema: z.object({ name, email, subject, message })
  - Export TypeScript type from schema

## Acceptance Criteria
✅ Form renders with all 4 fields
✅ Validation shows errors on invalid input
✅ Loading spinner shows during submission
✅ Success message appears on successful submission
✅ Error message appears on failure
✅ Responsive on mobile, tablet, desktop
✅ Passes accessibility audit (use testing-library/jest-dom)

## CRITICAL: Progress Reporting
⏰ **USE TodoWrite EVERY 60 SECONDS** to report progress!

Example:
TodoWrite({
  todos: [
    {id: "1", content: "Create Zod validation schema ✅", status: "completed", priority: "high"},
    {id: "2", content: "Build form component (adding fields...)", status: "in_progress", priority: "high"},
    {id: "3", content: "Add styling and responsiveness", status: "pending", priority: "medium"},
    {id: "4", content: "Test accessibility", status: "pending", priority: "medium"}
  ]
});

## Success Criteria
- Component can be imported and used on any page
- All validation rules work as expected
- Form submits to /api/contact endpoint (endpoint doesn't need to exist yet)
- Code follows Next.js 14 and React best practices

## Tools Available
["Read", "LS", "Execute", "Edit", "Create", "Grep", "Glob", "TodoWrite", "WebSearch", "FetchUrl"]
`
});

// After Task 1.1 completes, spawn Task 1.2
Task({
  subagent_type: "droidz-codegen",
  description: "Create contact form API endpoint with email delivery",
  prompt: `# Task: Create Contact Form API Endpoint

## Objective
Build a secure API endpoint that handles contact form submissions and sends emails.

## Context
**Project:** Existing Next.js 14 app (App Router)
**Tech Stack:** Next.js 14, TypeScript, Resend for email
**User Request:** Add email delivery for contact form
**Related Tasks:** Contact form component is complete (Task 1.1)

## Requirements
1. Create API route at \`app/api/contact/route.ts\`
2. Create email service in \`lib/email/contact-email.ts\`
3. Validate request body using Zod schema from Task 1.1
4. Send email via Resend API
5. Implement rate limiting (5 requests/hour per IP)
6. Return appropriate HTTP status codes
7. Use environment variables for secrets

## Files to Create
- \`app/api/contact/route.ts\`:
  - POST handler
  - Import Zod schema from \`lib/validations/contact.ts\`
  - Validate request body
  - Call email service
  - Return 200/400/500 appropriately
  - Rate limiting with @upstash/ratelimit or similar

- \`lib/email/contact-email.ts\`:
  - sendContactEmail() function
  - Resend integration
  - Email template (HTML)
  - Error handling

- \`.env.example\`:
  - RESEND_API_KEY=your_api_key_here
  - ADMIN_EMAIL=admin@example.com

## Acceptance Criteria
✅ POST /api/contact accepts form data
✅ Validation rejects invalid data with 400
✅ Email sends successfully on valid submission
✅ Rate limiting blocks after 5 requests (429 status)
✅ No secrets hardcoded (all in environment variables)
✅ Error handling for email service failures

## CRITICAL: Progress Reporting
⏰ **USE TodoWrite EVERY 60 SECONDS**

## Success Criteria
- API endpoint works in development (test with curl or Postman)
- Email is received at admin address
- Rate limiting can be verified by making 6 rapid requests

## Tools Available
["Read", "LS", "Execute", "Edit", "Create", "Grep", "Glob", "TodoWrite", "WebSearch", "FetchUrl"]
`
});

// After Task 1.2 completes, spawn Task 1.3
Task({
  subagent_type: "droidz-test",
  description: "Write comprehensive tests for contact form",
  prompt: `# Task: Write Tests for Contact Form Feature

## Objective
Create comprehensive test coverage for the contact form component and API endpoint.

## Context
**Project:** Existing Next.js 14 app
**User Request:** Add tests for contact form feature
**Related Tasks:** Component (Task 1.1) and API (Task 1.2) are complete

## Requirements
1. Component tests for ContactForm
2. API endpoint tests
3. Mock email service
4. Test validation, rate limiting, error handling
5. Achieve 80%+ coverage

## Files to Create
- \`__tests__/components/ContactForm.test.tsx\`
- \`__tests__/api/contact.test.ts\`

## Acceptance Criteria
✅ Component tests pass
✅ API tests pass
✅ Coverage ≥ 80%
✅ All edge cases tested (rate limiting, validation, errors)

## CRITICAL: Progress Reporting
⏰ **USE TodoWrite EVERY 60 SECONDS**

## Success Criteria
- All tests pass: npm test
- Coverage report shows ≥80%

## Tools Available
["Read", "LS", "Execute", "Edit", "Create", "Grep", "Glob", "TodoWrite", "WebSearch", "FetchUrl"]
`
});
```

**Estimated Time:**
- Sequential Execution: 2-3 hours total
  - Task 1.1: 60-90 minutes
  - Task 1.2: 45-60 minutes
  - Task 1.3: 30-45 minutes
- Parallel Execution: Not applicable (sequential dependencies)

</execution-plan>

<success-metrics>
**How to Measure Success:**

**Quality Metrics:**
- Test coverage: ≥ 80%
- All acceptance criteria met: Yes
- Zero critical bugs: Yes
- Accessibility score (Lighthouse): ≥ 90

**Performance Metrics:**
- Form submission response time: < 2 seconds (95th percentile)
- Time to Interactive (TTI): < 3 seconds
- Email delivery time: < 5 seconds

**Security Metrics:**
- Zero hardcoded secrets in codebase: Verified
- All inputs validated and sanitized: Verified
- Rate limiting functional: Verified (6th request blocked)
- No XSS vulnerabilities: Verified (submit script tags, ensure sanitized)

**UX Metrics:**
- Form completion rate: Track with analytics (target > 80%)
- Mobile usability: No console errors on mobile devices
- Accessibility: Zero critical accessibility issues

</success-metrics>

---

## Notes

This specification demonstrates the complete format generated by the `/droidz-build` command. Real specifications will be tailored to your specific project context, tech stack, and requirements.

**Key Features of This Format:**

1. **XML-structured sections** for clarity and consistency
2. **Detailed task decomposition** with specialist droid assignments
3. **Security requirements** when applicable
4. **Edge case handling** for robustness
5. **Comprehensive testing strategy**
6. **Measurable verification criteria**
7. **Ready-to-execute task prompts** in the execution plan
8. **Success metrics** for validation

**How to Use:**

1. Run `/droidz-build [your feature description]`
2. Answer any clarifying questions
3. Review the generated spec
4. Execute in parallel or sequentially
5. Track progress as droids work (they report every 60s)
6. Verify completion using the verification criteria

**Customization:**

Specs are generated based on your project's:
- Tech stack (detected from package.json)
- Framework patterns (detected from codebase)
- Existing standards (.factory/standards/)
- User requirements (from your description)
- Industry best practices (researched via exa-code and ref MCP)

For questions about this format, ask in the main conversation!
