---
phase: 02-alternative-airports
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/tools/flight-search.ts
autonomous: true

must_haves:
  truths:
    - "Empty flight search shows alternative airports inline instead of generic error"
    - "User sees max 3 nearby airports with drive time estimates"
    - "Original search params preserved when showing alternatives"
    - "Alternatives only shown for the airport that had no results (origin OR destination)"
  artifacts:
    - path: "lib/tools/flight-search.ts"
      provides: "Alternative airport integration in no-results handling"
      contains: "getNearbyAirports"
  key_links:
    - from: "lib/tools/flight-search.ts"
      to: "lib/api/duffel-client.ts"
      via: "imports getNearbyAirports"
      pattern: "import.*getNearbyAirports.*duffel-client"
    - from: "lib/tools/flight-search.ts"
      to: "lib/utils/tool-error-response.ts"
      via: "imports formatFlightErrorWithAlternatives"
      pattern: "import.*formatFlightErrorWithAlternatives.*tool-error-response"
---

<objective>
Integrate alternative airport suggestions into the flight search tool's "no results" handling, showing nearby airports inline when the original search returns empty.

Purpose: Prevent dead-end experiences by offering users actionable alternatives when flights aren't available from their chosen airport.

Output: Updated flight-search.ts that displays nearby airports with drive times when no flights are found.
</objective>

<execution_context>
@/Users/pascallammers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pascallammers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-alternative-airports/02-CONTEXT.md
@.planning/phases/02-alternative-airports/02-RESEARCH.md
@.planning/phases/02-alternative-airports/02-01-SUMMARY.md
@lib/tools/flight-search.ts
@lib/api/duffel-client.ts
@lib/utils/tool-error-response.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add imports and update no-results handling in flight-search.ts</name>
  <files>lib/tools/flight-search.ts</files>
  <action>
Integrate alternative airports into the flight search tool:

1. **Add new imports at top of file:**
```typescript
import { getNearbyAirports, NearbyAirport } from '@/lib/api/duffel-client';
import { formatFlightErrorWithAlternatives, AlternativeAirport } from '@/lib/utils/tool-error-response';
```

2. **Update the "no results" handling block** (around line 244-266):

Replace the existing block:
```typescript
if (!hasSeats && !hasDuffel) {
  const errorType = seatsError || duffelError ? 'provider_unavailable' : 'no_results';
  // ... existing error handling
}
```

With enhanced logic:

```typescript
if (!hasSeats && !hasDuffel) {
  // Determine error type
  const errorType = seatsError || duffelError ? 'provider_unavailable' : 'no_results';

  // Only search for alternatives if this is a "no_results" case (not provider failure)
  if (errorType === 'no_results') {
    console.log('[Flight Search] No results, searching for nearby airports...');

    // Determine which airport to find alternatives for
    // Heuristic: If origin is a major hub, likely destination had no flights
    // Otherwise, assume origin needs alternatives
    const majorHubs = ['LHR', 'FRA', 'CDG', 'AMS', 'JFK', 'LAX', 'DXB', 'SIN', 'HKG', 'NRT'];
    const emptyAirportCode = majorHubs.includes(origin) ? destination : origin;
    const emptyAirportType: 'origin' | 'destination' = majorHubs.includes(origin) ? 'destination' : 'origin';

    // Get nearby alternatives
    const nearbyAirports = await getNearbyAirports(emptyAirportCode);

    if (nearbyAirports.length > 0) {
      // Map to AlternativeAirport format
      const alternatives: AlternativeAirport[] = nearbyAirports.map(apt => ({
        code: apt.code,
        name: apt.name,
        city: apt.city,
        distance: apt.driveTime,
      }));

      // Build display name for the empty airport
      const emptyAirportDisplay = emptyAirportType === 'origin'
        ? originDisplay
        : destinationDisplay;

      return formatFlightErrorWithAlternatives({
        type: 'no_results',
        message: `F端r Ihre Suchkriterien wurden leider keine Fl端ge gefunden.`,
        alternatives,
        emptyAirport: emptyAirportType,
        originalAirportName: emptyAirportDisplay,
        searchParams: searchLinkParams,
      });
    }

    // No alternatives found - fall through to regular error
    console.log('[Flight Search] No nearby airports found within search radius');
  }

  // Provider failure or no alternatives - use existing error handling
  const technicalDetails =
    seatsError && duffelError
      ? 'Both Seats.aero and Duffel failed'
      : seatsError
        ? 'Seats.aero failed'
        : duffelError
          ? 'Duffel failed'
          : 'No flights matched search criteria';

  return formatGracefulFlightError({
    type: errorType,
    message:
      errorType === 'provider_unavailable'
        ? 'Die Flugsuche konnte keine Ergebnisse laden, da einige unserer Datenquellen vor端bergehend nicht erreichbar sind.'
        : 'Keine Fl端ge gefunden. Versuchen Sie andere Daten.',
    searchParams: searchLinkParams,
    technicalDetails,
  });
}
```

Key implementation notes:
- Major hub heuristic: If origin is a major hub (LHR, FRA, CDG, AMS, JFK, LAX, DXB, SIN, HKG, NRT), assume destination needs alternatives
- This follows CONTEXT.md: "Alternative ersetzt nur den Airport der 'leer' war"
- If getNearbyAirports returns empty, fall through to generic error message
- Only search alternatives for 'no_results', not 'provider_unavailable' (no point suggesting alternatives if APIs are down)
- Use originDisplay/destinationDisplay (from resolution) for friendly airport names in message
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
Flight search tool shows alternative airports with drive times when no flights are found, correctly identifying which airport (origin or destination) needs alternatives.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add console logging for alternative airport flow</name>
  <files>lib/tools/flight-search.ts</files>
  <action>
Add comprehensive logging for debugging the alternative airport flow:

1. **Add log when alternatives are found:**
After `const nearbyAirports = await getNearbyAirports(emptyAirportCode);`, add:
```typescript
console.log(`[Flight Search] Found ${nearbyAirports.length} nearby airports for ${emptyAirportCode}:`,
  nearbyAirports.map(a => `${a.code} (${a.driveTime})`).join(', '));
```

2. **Add log for which airport was selected:**
After determining emptyAirportCode, add:
```typescript
console.log(`[Flight Search] Looking for alternatives to ${emptyAirportType}: ${emptyAirportCode}`);
```

3. **Update the success case log:**
After mapping to alternatives, before return:
```typescript
console.log('[Flight Search] Returning alternatives response');
```

These logs help debug:
- Which airport the system decided needed alternatives
- How many alternatives were found
- Which codes and drive times are being returned
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
Console logs provide clear visibility into the alternative airport selection and results for debugging.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Flight search tool imports getNearbyAirports and formatFlightErrorWithAlternatives
3. No-results handling includes alternative airport search
4. Major hub heuristic correctly identifies which airport needs alternatives
5. Console logs provide debugging visibility
</verification>

<success_criteria>
- Flight search with no results shows alternative airports inline
- Alternatives include city, name, code, and drive time
- Message is in German with proper formatting
- Only one airport (origin OR destination) gets alternatives, not both
- If no alternatives found, falls back to generic "no flights" message
- Console logs show the alternative search flow for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/02-alternative-airports/02-02-SUMMARY.md`
</output>
