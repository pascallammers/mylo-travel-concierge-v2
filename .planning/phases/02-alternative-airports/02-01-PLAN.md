---
phase: 02-alternative-airports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/api/duffel-client.ts
  - lib/utils/tool-error-response.ts
autonomous: true

must_haves:
  truths:
    - "getNearbyAirports(code) returns up to 3 airports within dynamic radius"
    - "Each alternative includes code, name, city, and drive time estimate"
    - "formatFlightErrorWithAlternatives() produces German user message with inline alternatives"
    - "Drive time formatted as ~Xh Fahrt (not km)"
    - "Alternative format uses em-dash (—) as separator per CONTEXT.md example"
  artifacts:
    - path: "lib/api/duffel-client.ts"
      provides: "getNearbyAirports(), getDynamicRadius(), formatDriveTime()"
      exports: ["getNearbyAirports", "NearbyAirport"]
    - path: "lib/utils/tool-error-response.ts"
      provides: "Alternative airport display formatting"
      exports: ["AlternativeAirport", "formatFlightErrorWithAlternatives"]
  key_links:
    - from: "lib/api/duffel-client.ts"
      to: "Duffel Places API"
      via: "duffel.places.list() with lat/lng/rad params"
      pattern: "duffel\\.places\\.list"
    - from: "lib/utils/tool-error-response.ts"
      to: "lib/api/duffel-client.ts"
      via: "imports NearbyAirport type"
      pattern: "import.*NearbyAirport.*duffel-client"
---

<objective>
Add Duffel Places API integration for finding nearby airports and extend error response formatting to display alternatives inline with drive time estimates.

Purpose: Enable the flight search tool to suggest alternative airports when the original search returns no results, preventing dead-end experiences.

Output: getNearbyAirports() function in duffel-client.ts, formatFlightErrorWithAlternatives() in tool-error-response.ts
</objective>

<execution_context>
@/Users/pascallammers/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pascallammers/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-alternative-airports/02-CONTEXT.md
@.planning/phases/02-alternative-airports/02-RESEARCH.md
@lib/api/duffel-client.ts
@lib/utils/tool-error-response.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getNearbyAirports to duffel-client.ts</name>
  <files>lib/api/duffel-client.ts</files>
  <action>
Add nearby airport search functionality using Duffel Places API:

1. **Add NearbyAirport interface** (export it):
```typescript
export interface NearbyAirport {
  code: string;
  name: string;
  city: string;
  country: string;
  distanceMeters: number;
  driveTime: string;  // "~1,5h Fahrt"
}
```

2. **Add calculateHaversineDistance function** (internal helper):
- Earth radius: 6371000 meters
- Standard haversine formula
- Returns distance in meters

3. **Add formatDriveTime function** (internal helper):
- Assume 70 km/h average effective speed
- &lt; 0.5h: return "~30min Fahrt"
- 0.5h - 1.5h: round to 0.5 increments, return "~X,Xh Fahrt" (use comma for German decimal)
- &gt; 1.5h: round to whole hours, return "~Xh Fahrt"

4. **Add getDynamicRadius function** (export it):
- Dense regions (GB, DE, NL, BE, CH, AT, JP, KR): 100000m (100km)
- Sparse regions (US, CA, AU, BR, RU, CN, IN): 250000m (250km)
- Default: 150000m (150km)
- Takes countryCode: string, returns number (meters)

5. **Add getNearbyAirports async function** (export it):
```typescript
export async function getNearbyAirports(
  airportCode: string,
  radiusMeters?: number  // Optional, defaults to dynamic based on country
): Promise<NearbyAirport[]>
```

Implementation:
- Step 1: Query Duffel places.list({ query: airportCode }) to get origin coordinates
- Step 2: Find origin airport in results (type === 'airport' && iata_code === airportCode)
- Step 3: If not found, log warning and return empty array
- Step 4: Determine radius: if radiusMeters provided use it, else call getDynamicRadius(origin.iata_country_code)
- Step 5: Query Duffel places.list({ lat: origin.latitude.toString(), lng: origin.longitude.toString(), rad: radius.toString() })
- Step 6: Filter results: type === 'airport' && iata_code !== airportCode && iata_code exists
- Step 7: For each, calculate haversine distance from origin coords to result coords
- Step 8: Map to NearbyAirport with formatDriveTime for driveTime field
- Step 9: Sort by distanceMeters ascending
- Step 10: Slice to first 3
- Wrap in try/catch, log errors, return empty array on failure

Console logging:
- Log "[Duffel] Searching nearby airports:" with origin, lat, lng, radius at start
- Log "[Duffel] Found X nearby airports" at end
- Log "[Duffel] Nearby airport search failed:" on error
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
getNearbyAirports("FRA") can be called and returns NearbyAirport[] (may be empty if no Duffel key, but compiles and runs)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend tool-error-response.ts with alternative airport formatting</name>
  <files>lib/utils/tool-error-response.ts</files>
  <action>
Extend the error response module to support alternative airport display:

1. **Add AlternativeAirport interface** (export it):
```typescript
export interface AlternativeAirport {
  code: string;
  name: string;
  city: string;
  distance: string;  // Already formatted as "~1,5h Fahrt"
}
```

2. **Add GracefulErrorWithAlternatives interface** (export it):
```typescript
export interface GracefulErrorWithAlternatives extends GracefulErrorParams {
  alternatives?: AlternativeAirport[];
  emptyAirport?: 'origin' | 'destination';
  originalAirportName?: string;  // e.g., "Frankfurt (FRA)"
}
```

3. **Add formatFlightErrorWithAlternatives function** (export it):
```typescript
export function formatFlightErrorWithAlternatives(
  params: GracefulErrorWithAlternatives
): string
```

Implementation:
- If no alternatives or empty array, call and return formatGracefulFlightError(params)
- Otherwise build sections array:
  - Header: "## Keine Flüge gefunden\n"
  - Context: `Leider keine direkten Flüge ab ${params.originalAirportName || params.searchParams?.origin}.`
  - Subheader: "\n**Diese Flughäfen sind in der Nähe:**\n"
  - For each alternative (max 3):
    - Format: `- **${alt.city}** — ${alt.name} (${alt.code}) — ${alt.distance}`
    - **IMPORTANT**: Use em-dash (—) not hyphen (-) to match CONTEXT.md example format
  - Guidance: "\nKlicken Sie auf einen Flughafen, um die Suche zu wiederholen."
  - If searchParams provided, add fallback links section:
    - "\n**Oder nutzen Sie alternative Suchen:**"
    - Build Google Flights and Skyscanner URLs using existing buildGoogleFlightsUrl/buildSkyscannerUrl
    - `- [Google Flights](${googleUrl})`
    - `- [Skyscanner](${skyscannerUrl})`
- Return sections.join('\n')

Note: The exact wording follows CONTEXT.md decisions but Claude has discretion on exact phrasing.
  </action>
  <verify>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Verify em-dash usage by checking output format:
```typescript
// Quick test in node REPL or add temp console.log
const result = formatFlightErrorWithAlternatives({
  type: 'no_results',
  message: 'test',
  alternatives: [{code: 'HHN', name: 'Frankfurt-Hahn Airport', city: 'Hahn', distance: '~1,5h Fahrt'}],
  originalAirportName: 'Frankfurt (FRA)'
});
// Verify output contains "—" (em-dash) not "-" (hyphen)
```
  </verify>
  <done>
formatFlightErrorWithAlternatives() returns properly formatted German string with:
- Inline alternatives using em-dash (—) separator: "**Hahn** — Frankfurt-Hahn Airport (HHN) — ~1,5h Fahrt"
- Actionable guidance for clicking alternatives
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Both new exports are accessible from their modules
3. getNearbyAirports function signature matches interface
4. formatFlightErrorWithAlternatives produces valid markdown with alternatives list
5. Alternative format uses em-dash (—) as separator per CONTEXT.md example
</verification>

<success_criteria>
- getNearbyAirports() exported from duffel-client.ts with proper typing
- NearbyAirport interface exported for use in flight-search.ts
- formatFlightErrorWithAlternatives() produces German user message
- Drive times formatted as "~X,Xh Fahrt" not kilometers (German decimal comma)
- Alternative format matches CONTEXT.md: "City — Name (CODE) — ~Xh Fahrt" with em-dashes
- Dynamic radius function available for region-aware search
- No runtime errors in TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/02-alternative-airports/02-01-SUMMARY.md`
</output>
